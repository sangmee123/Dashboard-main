<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dashboard</title>
    <link rel="stylesheet" href="css/graph.css">
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/boost.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
</head>

<body>
    <div class="navibar"> 
        <p class="date"></p>
        <h1 class="time"></h1>
        <a href="index.html" class="orange"><img src="images/home_icon.png" class="icon"><p class="icon_p">home</p></a>
        <a href="map.html" class="orange"><img src="images/map_icon.png" class="icon"><p class="icon_p">map</p></a>
        <a href="graph.html" class="orange"><img src="images/graph_icon.png" class="icon"><p class="icon_p">graph</p></a>
        <a href="product.html" class="orange" title="트랙터 아이콘  제작자: Good Ware - Flaticon"><img src="images/product_icon.png" class="icon"><p class="icon_p">product</p></a>
        <a href="https://yghahm.cafe24.com/loin.php" target="_blank"><h1 class="text">MDS</h1></a>
 
        <div class="now">
            <img id="todayImg">
            <br><span class="todayWeather" id="weatherToday1"></span>
            <br><span class="todayWeather" id="weatherToday2"></span>
            <p id="connect" style="font-size:12px;">db연결 중...</p>
        </div>
    </div>
    <div class="logo">
        <a href="index.html"><img src="images/logo.png"></a>
        <a href="intro.html"><h4 class="information">회사소개</h4></a> 
        <a href="partner.html"><h4 class="information">협력사</h4></a>
        <!-- 모바일 햄버거 메뉴 -->
        <input type="checkbox" id="icon">
        <label for="icon">  <!--label은 인라인 스타일-->
            <span></span>
            <span></span>
            <span></span>
        </label>
        <div id="header">
            <ul>       
                <li><a href="intro.html"><h4 class="information_m">회사소개</h4></a></li><hr>
                <li><a href="partner.html"><h4 class="information_m">협력사</h4></a></li><hr>
            </ul>
        </div>
    </div>

    <div class="graph_top">
        <div class="selectBox">
            <select name="fruits" class="select">
                <option disabled selected hidden>기업 리스트</option>
                <optgroup label="영진기계">
                    <option value="9호기" class="opt1">9호기</option>
                    <option value="10호기" class="opt2">10호기</option>
                    <option value="11호기" class="opt3">11호기</option>
                 </optgroup>
            </select>
            <span class="icoArrow"><img src="images/arrow-down.png" alt=""></span>
        </div>
        

        <div id="chartdiv1"></div> <!-- Pressure 그래프 -->  
        <div id="chartdiv2"></div> <!-- Max Depth 그래프 -->  

        <div class="contents">
            <div id="menu">
                <h1 id="corporation_list"><b>기업 리스트</b></h1>
                <hr>
                <ul class="list">
                    <a href="#" class="li_c wth youngjin">영진 기계</a>
                    <ul class="y">
                        <li class="li_c li0 hide c">9호기</li> 
                        <li class="li_c li1 hide c">10호기</li> 
                        <li class="li_c li2 hide c">11호기</li> 
                    </ul>
                    <ul class="e">
                        <li class="li_c li2 c" style="display: none;">(임시)</li>
                        <li class="li_c li3 c" style="display: none;">(임시)</li>
                    </ul>
                </ul><hr>
            </div>
        </div>
    </div>

    <!-- 웹 PC 버전 -->
    <div class="graph_bottom">   
        <div id="chartdiv4"></div> <!-- Beat Position 그래프 -->
        <div id="chartdiv3"></div> <!-- Torque 그래프 -->  
        <div id="chartdiv5"></div> <!-- Inclination X & Y 그래프 -->
    </div>

    <script src="//code.jquery.com/jquery.min.js"></script> 
    <script>
        let m_IDX = 19; //기본 그래프 설정값 11호기

        /* All Data(Before + Live) */
        let arr1 = []; //pressure
        let arr2 = []; //max_depth
        let arr3 = []; //torque
        let arr4 = []; //beat_position
        let arr5 = []; //inclination(x, y)
        /* Before Data */
        let arr1_1 = []; //pressure
        let arr2_1 = []; //max_depth
        let arr3_1 = []; //torque
        let arr4_1 = []; //beat_position
        let arr5_1 = []; ////inclination(x, y)
        
        function list_9() {
            m_IDX = 8; //영진기계-9호기  
            arr1_1 = []; arr1_2_= []; arr1 = []; //pressure
            arr2_1 = []; arr2_2 = []; arr2 = []; //max_depth
            arr3_1 = []; arr3_2 = []; arr3 = []; //torque
            arr4_1 = []; arr4_2 = []; arr4 = []; //beat_position
            arr5_1 = []; arr5_2 = []; arr5 = []; //inclination(x, y)
            GET_db1(); //데이터 초기화
            $('.li0').css('backgroundColor', 'white');
            $('.li0').css('color', 'black');
            $('.li1').css('backgroundColor', '');
            $('.li2').css('backgroundColor', '');

            $('#chartdiv1').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
            $('#chartdiv2').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
            $('#menu').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
            $('#chartdiv3').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
            $('#chartdiv4').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
            $('#chartdiv5').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
            $('.selectBox').css('backgroundColor', 'rgba(91, 96, 101, 0.5)');
        }
        function list_10() {
            m_IDX = 14; //영진기계-10호기 
            arr1_1 = []; arr1_2_= []; arr1 = []; //pressure
            arr2_1 = []; arr2_2 = []; arr2 = []; //max_depth
            arr3_1 = []; arr3_2 = []; arr3 = []; //torque
            arr4_1 = []; arr4_2 = []; arr4 = []; //beat_position
            arr5_1 = []; arr5_2 = []; arr5 = []; //inclination(x, y)
            GET_db1(); //데이터 초기화
            $('.li1').css('backgroundColor', 'white');
            $('.li1').css('color', 'black');
            $('.li0').css('backgroundColor', '');
            $('.li2').css('backgroundColor', '');

            $('#chartdiv1').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
            $('#chartdiv2').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
            $('#menu').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
            $('#chartdiv3').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
            $('#chartdiv4').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
            $('#chartdiv5').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
            $('.selectBox').css('backgroundColor', 'rgba(49, 69, 70, 0.4)');
        }
        function list_11() {
            m_IDX = 19; //영진기계-11호기 
            arr1_1 = []; arr1_2_= []; arr1 = []; //pressure
            arr2_1 = []; arr2_2 = []; arr2 = []; //max_depth
            arr3_1 = []; arr3_2 = []; arr3 = []; //torque
            arr4_1 = []; arr4_2 = []; arr4 = []; //beat_position
            arr5_1 = []; arr5_2 = []; arr5 = []; //inclination(x, y)
            GET_db1(); //데이터 초기화
            $('.li2').css('backgroundColor', 'white');
            $('.li2').css('color', 'black');
            $('.li0').css('backgroundColor', '');
            $('.li1').css('backgroundColor', '');

            $('#chartdiv1').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
            $('#chartdiv2').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
            $('#menu').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
            $('#chartdiv3').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
            $('#chartdiv4').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
            $('#chartdiv5').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
            $('.selectBox').css('backgroundColor', 'rgba(24, 38, 51, 0.4)');
        }        

        /* 웹 PC - 기업 리스트에서 영진기계를 선택시*/
        $('.youngjin').on('click', function() {
            $('.hide').css('display') == 'none' ?
            $('.hide').css('display', 'block') : 
            $('.hide').css('display', 'none');
        });
        $('.li0').on('click', function() { list_9(); });  //9호기 선택시
        $('.li1').on('click', function() { list_10(); }); //10호기 선택시
        $('.li2').on('click', function() { list_11(); }); //11호기 선택시

        /* 모바일 - 기업 리스트(영진기계) */
        $('select').change(function(e) { 
            if($(e.target).val() === "9호기") { list_9(); }
            else if($(e.target).val() === "10호기") { list_10(); } 
            else if($(e.target).val() === "11호기") { list_11(); }
        });

        const period = 3000;
        GET_db1(); /* Before Data */   
        setInterval(GET_db2, period); // 3초 단위로 갱신 처리
        function GET_db1() {
            $.ajax({
                url: "GET_db.php",
                type: "POST", 
                data: { m_IDX: m_IDX },
                async: false,
            }).done(function(data) {
                data = JSON.parse(data);
                for(i in data){
                    if(data[i].result == "success") {
                        arr1_1.push({
                            year: data[i].collecttime, 
                            value: Math.abs(data[i].pressure) })
                        arr2_1.push({ 
                            year: data[i].collecttime, 
                            value: Math.abs(data[i].max_depth / 1000) + 0.0001 });
                        arr3_1.push({ 
                            year: data[i].collecttime,
                            value: Math.abs(data[i].torque) });
                        arr4_1.push({
                            year: data[i].collecttime,
                            value: Math.abs(data[i].beat_position / 1000) + 0.0001 });
                        let inX = data[i].inclination_x;
                        let inY = data[i].inclination_y;
                        if(inX > 18000) inX = 36000 - data[i].inclination_x;
                        if(inY > 18000) inY = 36000 - data[i].inclination_y;
                        arr5_1.push({ 
                            date1: data[i].collecttime,
                            value1: Math.abs(inX / 100),
                            date2: data[i].collecttime, 
                            value2: Math.abs(inY / 100) });
                    }
                } 
                $('#connect').text("DB 연결 성공");
            }).fail(function(data) {
                $('#connect').text("HTTP 요청 실패");
            });
        }

        /* Live Data */
        let arr1_2 = []; //pressure
        let arr2_2 = []; //max_depth
        let arr3_2 = []; //torque
        let arr4_2 = []; //beat_position
        let arr5_2 = []; //inclination(x, y)  
        function GET_db2() {
            $.ajax({
                url: "GET_db2.php",
                type: "POST", 
                data: { m_IDX: m_IDX },
                async: false,
            }).done(function(data) {
                data = JSON.parse(data);
                if(data.result == "success") {
                    arr1_2.push({ 
                        year: data.collecttime,
                        value: Math.abs(data.pressure) }); 
                    arr2_2.push({ 
                        year: data.collecttime, 
                        value: Math.abs(data.max_depth / 1000) + 0.0001 });
                    arr3_2.push({ 
                        year: data.collecttime,
                        value: Math.abs(data.torque) });
                    arr4_2.push({
                        year: data.collecttime,
                        value: Math.abs(data.beat_position / 1000) + 0.0001 });

                    let inX = data.inclination_x;
                    let inY = data.inclination_y;
                    if(inX > 18000) inX = 36000 - data.inclination_x;
                    if(inY > 18000) inY = 36000 - data.inclination_y;
                    arr5_2.push({ 
                        date1: data.collecttime,
                        value1: Math.abs(inX / 100),
                        date2: data.collecttime,
                        value2: Math.abs(inY / 100) });

                    /* Before + Live => Data 이어 붙이기 */
                    arr1 = arr1_1.concat(arr1_2);
                    arr2 = arr2_1.concat(arr2_2);
                    arr3 = arr3_1.concat(arr3_2);
                    arr4 = arr4_1.concat(arr4_2);
                    arr5 = arr5_1.concat(arr5_2); 
                }
                $('#connect').text("DB 연결 성공");
            }).fail(function(data) {
                $('#connect').text("HTTP 요청 실패");
            });
        }         
    </script>  
    <script src="js/graph.js"></script> 
</body>    
</html>